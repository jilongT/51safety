<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>贪吃蛇游戏</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #acd8ec;
        }

        canvas {
            border: 1px solid #9db326;
            background-color: #e7eccf;
            position: relative;
            max-width: 100%;
            max-height: 80vh;
        }

        .button-container {
            display: flex;
            justify-content: center;
            width: 100%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        button {
            margin: 5px;
            padding: 10px 20px;
            font-size: 20px;
            font-weight: bold;
            background-color: #ecee80;
            border-radius: 5px;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }

        button:active {
            background-color: #d6d873;
        }

        #score {
            margin-top: 10px;
            font-size: 24px;
        }
    </style>
</head>

<body>
	<div>
		通过触摸滑动屏幕操控，消灭火点
	</div>
    <canvas id="gameCanvas" width="400" height="400"></canvas>
    <div class="button-container">
        <button id="startButton">开始游戏</button>
        <button id="restartButton" style="display: none;">重新开始</button>
        <button id="homeButton" style="display: none;">返回主页</button>
    </div>
    <div id="score" style="margin-top: 10px;">Score: 0</div>
    <script>
        // 1. 初始化 Canvas 和游戏变量
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const startButton = document.getElementById("startButton");
        const restartButton = document.getElementById("restartButton");
        const homeButton = document.getElementById("homeButton");
        const scoreDisplay = document.getElementById("score");
        const gridSize = 20;
        const rows = Math.floor(canvas.height / gridSize);
        const cols = Math.floor(canvas.width / gridSize);

        let snake = [];
        let food = {};
        let direction = { x: 1, y: 0 };
        let lastDirection = { ...direction };
        let gameOver = false;
        let score = 0;
        let foodImage;

        // 创建火苗 SVG 元素
        const fireSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        fireSvg.setAttribute('viewBox', '0 0 100 100');
        fireSvg.setAttribute('width', gridSize);
        fireSvg.setAttribute('height', gridSize);

        const firePath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        firePath.setAttribute('d', 'M50 0 C60 20 80 40 70 60 C60 80 40 80 30 60 C20 40 40 20 50 0');
        firePath.setAttribute('fill', '#FF5733');
        fireSvg.appendChild(firePath);

        // 初始化食物图片
        function initFoodImage() {
            const svgData = new XMLSerializer().serializeToString(fireSvg);
            const svgBlob = new Blob([svgData], { type: 'image/svg+xml;charset=utf-8' });
            const url = URL.createObjectURL(svgBlob);
            foodImage = new Image();
            foodImage.src = url;
            foodImage.onload = function () {
                URL.revokeObjectURL(url);
            };
            foodImage.onerror = function () {
                console.error('Failed to load food image');
            };
        }

        // 2. 初始化游戏
        function initGame() {
            // 初始化蛇的位置和长度
            snake = [
                { x: Math.floor(cols / 2), y: Math.floor(rows / 2) },
                { x: Math.floor(cols / 2) - 1, y: Math.floor(rows / 2) },
            ];
            // 初始化食物的位置
            food = {
                x: Math.floor(Math.random() * cols),
                y: Math.floor(Math.random() * rows),
            };
            // 初始化蛇的方向
            direction = { x: 1, y: 0 };
            lastDirection = { ...direction };
            // 游戏状态
            gameOver = false;
            // 重置分数
            score = 0;
            scoreDisplay.textContent = `Score: ${score}`;
            // 隐藏开始按钮
            startButton.style.display = "none";
            // 隐藏重启和返回主页按钮
            restartButton.style.display = "none";
            homeButton.style.display = "none";
            // 开始游戏循环
            gameLoop();
        }

        // 3. 绘制单个格子
        function drawCell(x, y, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x * gridSize, y * gridSize, gridSize, gridSize);
            ctx.strokeStyle = "#000";
            ctx.lineWidth = 2;
            ctx.strokeRect(x * gridSize, y * gridSize, gridSize, gridSize);
        }

        // 4. 绘制蛇
        function drawSnake() {
            snake.forEach((part) => drawCell(part.x, part.y, "#409EFF"));
        }

        // 5. 绘制食物
        function drawFood() {
            if (foodImage) {
                ctx.drawImage(foodImage, food.x * gridSize, food.y * gridSize, gridSize, gridSize);
            }
        }

        // 6. 更新蛇的位置和状态
        function updateSnake() {
            const head = { x: snake[0].x + direction.x, y: snake[0].y + direction.y };
            if (head.x === food.x && head.y === food.y) {
                score++;
                scoreDisplay.textContent = `Score: ${score}`;
                food = {
                    x: Math.floor(Math.random() * cols),
                    y: Math.floor(Math.random() * rows),
                };
            } else {
                snake.pop();
            }
            snake.unshift(head);
            // 撞墙或撞到自己
            if (
                head.x < 0 ||
                head.x >= cols ||
                head.y < 0 ||
                head.y >= rows ||
                snake.slice(1).some((part) => part.x === head.x && part.y === head.y)
            ) {
                gameOver = true;
            }
            lastDirection = { ...direction };
        }

        // 7. 游戏循环
        function gameLoop() {
            if (!gameOver) {
                // 清除画布并绘制食物和蛇
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                drawFood();
                updateSnake();
                drawSnake();
                setTimeout(gameLoop, 100);
            } else {
                // 游戏结束，显示“Game Over”、重新开始和返回主页按钮
                ctx.font = "60px Arial";
                ctx.fillStyle = "#F56C6C";
                ctx.fillText("游戏结束", canvas.width / 4, canvas.height / 3);
                ctx.font = "30px Arial";
                ctx.fillText(`消灭火点: ${score}`, canvas.width / 3, canvas.height / 3 + 50);
                restartButton.style.display = "block";
                homeButton.style.display = "block";
            }
        }

        // 监听键盘事件来改变蛇的方向
        window.addEventListener("keydown", (event) => {
            const newDirection = getNewDirection(event.key);
            if (newDirection) {
                direction = newDirection;
            }
        });

        // 监听触摸事件来改变蛇的方向
        let touchStartX, touchStartY;
        canvas.addEventListener("touchstart", (event) => {
            event.preventDefault(); // 阻止默认触摸行为
            touchStartX = event.touches[0].clientX;
            touchStartY = event.touches[0].clientY;
        });

        canvas.addEventListener("touchend", (event) => {
            event.preventDefault(); // 阻止默认触摸行为
            const touchEndX = event.changedTouches[0].clientX;
            const touchEndY = event.changedTouches[0].clientY;
            const dx = touchEndX - touchStartX;
            const dy = touchEndY - touchStartY;
            const newDirection = getNewDirectionFromTouch(dx, dy);
            if (newDirection) {
                direction = newDirection;
            }
        });

        // 获取新的方向
        function getNewDirection(key) {
            switch (key) {
                case "ArrowUp":
                    if (lastDirection.y === 0) return { x: 0, y: -1 };
                    break;
                case "ArrowDown":
                    if (lastDirection.y === 0) return { x: 0, y: 1 };
                    break;
                case "ArrowLeft":
                    if (lastDirection.x === 0) return { x: -1, y: 0 };
                    break;
                case "ArrowRight":
                    if (lastDirection.x === 0) return { x: 1, y: 0 };
                    break;
            }
            return null;
        }

        // 从触摸事件获取新的方向
        function getNewDirectionFromTouch(dx, dy) {
            if (Math.abs(dx) > Math.abs(dy)) {
                if (dx > 0 && lastDirection.x === 0) {
                    return { x: 1, y: 0 };
                } else if (dx < 0 && lastDirection.x === 0) {
                    return { x: -1, y: 0 };
                }
            } else {
                if (dy > 0 && lastDirection.y === 0) {
                    return { x: 0, y: 1 };
                } else if (dy < 0 && lastDirection.y === 0) {
                    return { x: 0, y: -1 };
                }
            }
            return null;
        }

        // 8. 重新开始游戏
        function restartGame() {
            initGame();
        }

        // 9. 返回主页
        function goHome() {
            // 这里可以添加返回主页的具体逻辑，例如跳转到指定页面
            window.location.href = "../index.html";
        }

        // 绑定开始按钮的点击事件
        startButton.addEventListener("click", initGame);

        // 绑定重启按钮的点击事件
        restartButton.addEventListener("click", restartGame);

        // 绑定返回主页按钮的点击事件
        homeButton.addEventListener("click", goHome);

        // 页面加载完成后显示开始按钮并初始化食物图片
        window.onload = function () {
            startButton.style.display = "block";
            initFoodImage();
        };
    </script>
</body>

</html>    